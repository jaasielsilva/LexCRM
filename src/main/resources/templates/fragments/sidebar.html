<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<body>

    <div th:fragment="sidebar(activePage)" class="sidebar" id="app-sidebar">
        <!-- Sidebar CSS Isolated -->
        <link rel="stylesheet" th:href="@{/css/sidebar.css}">

        <div class="sidebar-header">
            <div class="brand-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <div class="brand-text">
                <h1>Juris<span>CRM</span></h1>
                <p class="brand-subtitle">Gestão Jurídica</p>
            </div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-category">Principal</div>
            <a href="/dashboard" class="nav-link" th:classappend="${activePage == 'dashboard'} ? 'active'">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a href="/clientes" class="nav-link" th:classappend="${activePage == 'clientes'} ? 'active'">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
            <a href="/processos" class="nav-link" th:classappend="${activePage == 'processos'} ? 'active'">
                <i class="fas fa-balance-scale"></i>
                <span>Processos</span>
            </a>
            <a href="/documentacoes" class="nav-link" th:classappend="${activePage == 'documentacoes'} ? 'active'">
                <i class="fas fa-folder"></i>
                <span>Documentações</span>
            </a>

            <div class="menu-category">Gestão</div>
            <a href="/agenda" class="nav-link" th:classappend="${activePage == 'agenda'} ? 'active'">
                <i class="fas fa-calendar-alt"></i>
                <span>Agenda</span>
            </a>
            <a href="/financeiro" class="nav-link" th:classappend="${activePage == 'financeiro'} ? 'active'">
                <i class="fas fa-dollar-sign"></i>
                <span>Financeiro</span>
            </a>
            <a href="/relatorios" class="nav-link" th:classappend="${activePage == 'relatorios'} ? 'active'">
                <i class="fas fa-file-alt"></i>
                <span>Relatórios</span>
            </a>

            <div class="menu-category">Sistema</div>
            <a href="/configuracoes" class="nav-link" th:classappend="${activePage == 'configuracoes'} ? 'active'">
                <i class="fas fa-cog"></i>
                <span>Configurações</span>
            </a>
        </div>

        <div class="sidebar-footer" onclick="openPerfilModal()" style="cursor: pointer;" title="Meu Perfil">
            <div class="user-avatar">
                <span
                    th:text="${#authentication?.name != null && #authentication.name.length() >= 2 ? #authentication.name.substring(0,2).toUpperCase() : 'US'}">US</span>
            </div>
            <div class="user-info">
                <p class="user-name" th:text="${#authentication?.name ?: 'Visitante'}">Usuário</p>
                <p class="user-role"
                    th:text="${#authentication?.authorities != null ? #authentication.authorities[0].toString().replace('ROLE_', '').replace('[', '').replace(']', '') : 'Convidado'}">
                    Role</p>
            </div>
            <form th:action="@{/logout}" method="post" style="margin: 0;" onclick="event.stopPropagation()">
                <button type="submit" title="Sair"
                    style="background:none; border:none; color: #64748b; cursor: pointer; padding: 5px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script th:src="@{/js/ui-swal.js}"></script>
        <script>
            function openPerfilModal() {
                Swal.fire({
                    title: 'Carregando...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        fetch('/perfil')
                            .then(response => response.text())
                            .then(html => {
                                Swal.fire({
                                    html: html,
                                    showConfirmButton: false,
                                    showCancelButton: false,
                                    width: 500,
                                    padding: '0',
                                    customClass: {
                                        popup: 'modal-content-premium'
                                    },
                                    didOpen: () => {
                                        const container = document.querySelector('.swal2-html-container');
                                        if (container && window.htmx) {
                                            htmx.process(container);
                                        }
                                    }
                                });
                            });
                    }
                });
            }

            function closeModal() {
                Swal.close();
            }

            window.togglePerfilTab = function (tab) {
                const formInfo = document.getElementById('form-perfil-info');
                const formSenha = document.getElementById('form-perfil-senha');
                const btnInfo = document.getElementById('btn-tab-info');
                const btnSenha = document.getElementById('btn-tab-senha');

                if (!formInfo || !formSenha) return;

                if (tab === 'info') {
                    formInfo.classList.remove('hidden');
                    formSenha.classList.add('hidden');
                    btnInfo.classList.add('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnInfo.classList.remove('text-gray-400', 'border-transparent');
                    btnSenha.classList.remove('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnSenha.classList.add('text-gray-400', 'border-transparent');
                } else {
                    formInfo.classList.add('hidden');
                    formSenha.classList.remove('hidden');
                    btnSenha.classList.add('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnSenha.classList.remove('text-gray-400', 'border-transparent');
                    btnInfo.classList.remove('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnInfo.classList.add('text-gray-400', 'border-transparent');
                }
            }

            // Global HTMX CSRF Configuration
            document.body.addEventListener('htmx:configRequest', function (evt) {
                const tokenMeta = document.querySelector('meta[name="_csrf"]');
                const headerMeta = document.querySelector('meta[name="_csrf_header"]');
                if (tokenMeta && headerMeta) {
                    const token = tokenMeta.getAttribute('content');
                    const header = headerMeta.getAttribute('content');
                    evt.detail.headers[header] = token;
                }
            });
        </script>
    </div>

</body>

</html>