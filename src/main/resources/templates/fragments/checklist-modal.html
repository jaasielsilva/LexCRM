<!-- Checklist Modal Content -->
<div th:fragment="content" class="checklist-container">
    <div class="checklist-header mb-4">
        <h3 class="text-lg font-bold text-[var(--navy-blue)]">
            <i class="fas fa-tasks mr-2 text-[var(--gold)]"></i>
            Lista de Documentos
        </h3>
        <p class="text-sm text-gray-500">Marque os documentos recebidos para concluir a etapa.</p>
    </div>

    <!-- Caso específico: Documentos Solicitados (Lista Estática para Envio) -->
    <div th:if="${etapa.nome == 'Documentos Solicitados'}" class="mb-4">
        <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-3 text-sm text-blue-800">
            <i class="fas fa-info-circle mr-1"></i>
            Confira a lista abaixo e clique em enviar para mandar ao cliente.
        </div>
        <ul
            class="space-y-2 text-sm text-gray-700 list-disc list-inside bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4">
            <li>RG ou CNH</li>
            <li>Comprovante de residência</li>
            <li>Carteira de trabalho (Digital/PDF)</li>
            <li>Últimos 3 holerites antes do diagnóstico</li>
            <li>Documentos médicos (Laudos, Tomografia, Raio-X, Prontuário)</li>
            <li>Dados bancários para indenização</li>
            <li>E-mail para envio de documentação</li>
            <li>B.O ou C.A.T (caso tenha)</li>
        </ul>

        <button type="button"
            th:onclick="sendWhatsAppList([[${etapa.processo.cliente.telefone}]], [[${etapa.processo.cliente.nome}]])"
            class="btn-premium-primary w-full justify-center gap-2 !bg-[#25D366] !border-[#25D366] hover:!bg-[#128C7E] hover:!border-[#128C7E] text-white font-bold py-2 px-4 rounded-lg shadow-sm transition-all">
            <i class="fab fa-whatsapp text-lg"></i>
            Enviar Lista por WhatsApp
        </button>
    </div>

    <ul class="space-y-3" th:if="${not #lists.isEmpty(etapa.checklist)}">
        <li th:each="doc : ${etapa.checklist}"
            class="flex items-start gap-3 p-3 rounded-lg border transition-all duration-200"
            th:classappend="${doc.entregue} ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200 hover:border-[var(--gold)]'">

            <div class="pt-1">
                <input type="checkbox" th:checked="${doc.entregue}"
                    class="w-5 h-5 text-[var(--navy-blue)] rounded border-gray-300 focus:ring-[var(--gold)] cursor-pointer"
                    th:attr="hx-post=@{/processos/{pid}/etapa/{eid}/checklist/{did}/toggle(pid=${etapa.processo.id}, eid=${etapa.id}, did=${doc.id})}"
                    hx-swap="outerHTML" hx-target="closest .checklist-container">
            </div>

            <div class="flex-1">
                <span class="text-sm font-medium"
                    th:classappend="${doc.entregue} ? 'text-green-800 line-through opacity-70' : 'text-gray-800'"
                    th:text="${doc.nome}">
                    RG ou CNH
                </span>
            </div>

            <div th:if="${doc.entregue}">
                <i class="fas fa-check text-green-600 text-sm"></i>
            </div>
        </li>
    </ul>

    <!-- Status Footer -->
    <div class="mt-6 pt-4 border-t border-gray-100 flex justify-between items-center">
        <span class="text-xs font-semibold uppercase tracking-wider text-gray-500">Status da Etapa</span>
        <span class="px-3 py-1 rounded-full text-xs font-bold uppercase"
            th:classappend="${etapa.status == 'Concluído'} ? 'bg-green-100 text-green-700' : (${etapa.status == 'Em Andamento'} ? 'bg-amber-100 text-amber-700' : 'bg-red-100 text-red-700')"
            th:text="${etapa.status}">
            Pendente
        </span>
    </div>

    <div class="mt-4 flex justify-end gap-2">
        <button type="button" class="btn btn-secondary" onclick="closeChecklistModal()">Fechar</button>

        <!-- Botão Salvar (Só se não concluído) -->
        <button th:if="${etapa.status != 'Concluído'}" type="button" class="btn-premium-primary py-2 px-4 text-sm"
            th:attr="hx-post=@{/processos/etapa/{eid}/checklist/save(eid=${etapa.id})}" hx-swap="innerHTML"
            hx-target="#checklist-modal-body"
            th:text="${etapa.nome == 'Documentos Solicitados' ? 'Concluir (Lista Enviada)' : 'Confirmar Recebimento'}">
            Confirmar Recebimento
        </button>

        <!-- Botão Reabrir (Só para Admin se concluído) -->
        <button sec:authorize="hasRole('ADMIN')" th:if="${etapa.status == 'Concluído'}" type="button"
            class="btn-premium-secondary !bg-amber-100 !text-amber-700 !border-amber-200 py-2 px-4 text-sm"
            th:attr="onclick=|confirmReabrirEtapa('${etapa.id}')|">
            <i class="fas fa-lock-open mr-2"></i>Reabrir Etapa (Admin)
        </button>
    </div>

    <!-- OOB Updates for Timeline & Progress Bar -->
    <div th:if="${hxOobSwap}">
        <div th:replace="~{fragments/timeline-view :: timeline}"></div>
        <div th:replace="~{fragments/progress-bar :: progressBar(${processo})}"></div>
    </div>

    <!-- Script para fechar modal e avisar sucesso se concluir (Via POST) -->
    <script th:if="${successMessage != null}" th:inline="javascript">
        closeChecklistModal();
        if (window.uiToastSuccess) {
            window.uiToastSuccess(/*[[${successMessage}]]*/ 'Sucesso!');
        }
    </script>

    <script>
        function sendWhatsAppList(phone, name) {
            if (!phone) {
                if (window.uiToastError) uiToastError('Cliente sem telefone cadastrado.');
                return;
            }

            var cleanPhone = phone.replace(/\D/g, '');
            var text = "Olá " + (name || 'Cliente') + ",\n" +
                "Segue a lista de documentos necessários para o seu processo:\n\n" +
                "- RG ou CNH\n" +
                "- Comprovante de residência\n" +
                "- Carteira de trabalho (Digital/PDF)\n" +
                "- Últimos 3 holerites antes do diagnóstico\n" +
                "- Documentos médicos (Laudos, Tomografia, Raio-X, Prontuário)\n" +
                "- Dados bancários para indenização\n" +
                "- E-mail para envio de documentação\n" +
                "- B.O ou C.A.T (caso tenha)";

            var url = "whatsapp://send?phone=55" + cleanPhone + "&text=" + encodeURIComponent(text);
            window.open(url, '_blank');
        }
    </script>
</div>

<!-- Modal Wrapper (Initial Load) -->
<div th:fragment="modal" id="checklistModal" class="modal">
    <div class="modal-content max-w-lg">
        <div class="modal-header">
            <h2 class="font-playfair text-xl font-bold text-[var(--navy-blue)]">Documentação</h2>
            <button onclick="closeChecklistModal()" class="btn-ghost">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body" id="checklist-modal-body">
            <!-- Content will be loaded here -->
            <div class="text-center py-8">
                <i class="fas fa-circle-notch fa-spin text-2xl text-gray-300"></i>
            </div>
        </div>
    </div>
</div>