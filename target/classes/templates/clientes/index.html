<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clientes - JurisCRM</title>

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/tailwind.css}">

    <script src="https://unpkg.com/htmx.org@1.9.6"></script>
</head>
<body>

    <div th:replace="~{fragments/sidebar :: sidebar(activePage='clientes')}"></div>

    <main class="main-content" id="clientes-modulo" style="margin-left: 280px; margin: 0 auto 0 280px;">
        <div class="page-header">
            <div>
                <h1 class="page-title">Clientes</h1>
                <p class="page-subtitle">Cadastro e gestão de clientes do CRM</p>
            </div>
            <button type="button" onclick="openClienteModal()" class="btn-new-process">
                <i class="fas fa-plus"></i>
                Novo Cliente
            </button>
        </div>

        <div class="search-container">
            <i class="fas fa-search search-icon"></i>
            <input type="text"
                   name="query"
                   class="search-input"
                   placeholder="Buscar por nome, CPF/CNPJ, e-mail ou telefone..."
                   hx-get="/clientes/search"
                   hx-trigger="keyup changed delay:400ms"
                   hx-target="#client-list">
        </div>

        <div id="client-list" th:fragment="list">
            <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                <div class="table-responsive">
                    <table class="table table-sm align-middle mb-0">
                        <thead>
                            <tr class="text-uppercase small text-muted">
                                <th>Cliente</th>
                                <th>CPF/CNPJ</th>
                                <th>E-mail</th>
                                <th>Telefone</th>
                                <th class="text-end">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:if="${#lists.isEmpty(clientes)}">
                                <td colspan="5" class="text-center text-muted py-4">Nenhum cliente cadastrado.</td>
                            </tr>
                            <tr th:each="c : ${clientes}">
                                <td class="fw-semibold" th:text="${c.nome}">Nome</td>
                                <td class="small cpfcnpj-cell" th:text="${c.cpfCnpj}">000</td>
                                <td class="small" th:text="${c.email}">email</td>
                                <td class="small phone-cell" th:text="${c.telefone}">telefone</td>
                                <td class="text-end">
                                    <button type="button"
                                            class="btn btn-sm btn-outline-primary"
                                            th:attr="data-id=${c.id},data-nome=${c.nome},data-cpfcnpj=${c.cpfCnpj},data-email=${c.email},data-telefone=${c.telefone}"
                                            onclick="openClienteModalFromRow(this)">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <a class="btn btn-sm btn-outline-secondary"
                                       th:href="@{'/processos'(clienteId=${c.id})}"
                                       title="Ver processos do cliente">
                                        <i class="fas fa-folder-open"></i>
                                    </a>
                                    <button type="button"
                                            class="btn btn-sm btn-outline-danger"
                                            th:attr="data-id=${c.id},data-nome=${c.nome}"
                                            onclick="confirmDeleteClienteFromRow(this)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="d-flex align-items-center justify-content-between border-top p-3">
                    <div class="small text-muted">
                        Mostrando <span th:text="${fromItem}">0</span>–<span th:text="${toItem}">0</span> de <span th:text="${totalElements}">0</span>
                    </div>
                    <div class="btn-group" role="group" aria-label="Paginação">
                        <a class="btn btn-outline-secondary btn-sm"
                           th:classappend="${clientesPage.first} ? ' disabled'"
                           th:href="@{'/clientes'(page=${currentPage - 1}, size=${pageSize})}">
                            Anterior
                        </a>
                        <a class="btn btn-outline-secondary btn-sm"
                           th:classappend="${clientesPage.last} ? ' disabled'"
                           th:href="@{'/clientes'(page=${currentPage + 1}, size=${pageSize})}">
                            Próximo
                        </a>
                    </div>
                    <div class="d-flex align-items-center">
                        <label class="small text-muted me-2">Itens por página</label>
                        <select class="form-select form-select-sm"
                                th:value="${pageSize}"
                                onchange="location.href='/clientes?size=' + this.value">
                            <option value="10" th:selected="${pageSize == 10}">10</option>
                            <option value="20" th:selected="${pageSize == 20}">20</option>
                            <option value="50" th:selected="${pageSize == 50}">50</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        document.body.addEventListener('htmx:configRequest', function(evt) {
            var tokenMeta = document.querySelector('meta[name="_csrf"]');
            var headerMeta = document.querySelector('meta[name="_csrf_header"]');
            if (!tokenMeta || !headerMeta) {
                return;
            }
            evt.detail.headers[headerMeta.getAttribute('content')] = tokenMeta.getAttribute('content');
        });

        function refreshClientesList() {
            var input = document.querySelector('input[name="query"]');
            var q = input ? (input.value || '') : '';
            htmx.ajax('GET', '/clientes/search?query=' + encodeURIComponent(q), '#client-list');
        }

        function clienteFormHtml(values) {
            var v = values || {};
            return '' +
                '<form id="cliente-form" class="text-start">' +
                '  <div class="mb-3">' +
                '    <label class="form-label">Nome</label>' +
                '    <input name="nome" class="form-control" value="' + (v.nome || '') + '" required>' +
                '  </div>' +
                '  <div class="mb-3">' +
                '    <label class="form-label">CPF/CNPJ</label>' +
                '    <input name="cpfCnpj" class="form-control" value="' + (v.cpfCnpj || '') + '" required>' +
                '  </div>' +
                '  <div class="mb-3">' +
                '    <label class="form-label">E-mail</label>' +
                '    <input name="email" type="email" class="form-control" value="' + (v.email || '') + '">' +
                '  </div>' +
                '  <div class="mb-0">' +
                '    <label class="form-label">Telefone</label>' +
                '    <input name="telefone" class="form-control" value="' + (v.telefone || '') + '">' +
                '  </div>' +
                '</form>';
        }

        function openClienteModal() {
            openClienteModalInternal(null);
        }

        function openClienteModalFromRow(button) {
            var d = button ? button.dataset : {};
            openClienteModalInternal({
                id: d.id,
                nome: d.nome,
                cpfCnpj: d.cpfcnpj,
                email: d.email,
                telefone: d.telefone
            });
        }

        function openClienteModalInternal(data) {
            var isEdit = data && data.id;
            var title = isEdit ? 'Editar Cliente' : 'Novo Cliente';
            var url = isEdit ? ('/clientes/' + data.id) : '/clientes';

            Swal.fire({
                title: title,
                html: clienteFormHtml(data),
                showCancelButton: true,
                confirmButtonText: 'Salvar',
                cancelButtonText: 'Cancelar',
                focusConfirm: false,
                didOpen: function (dom) {
                    var input = dom.querySelector('input[name="cpfCnpj"]');
                    if (input && window.uiMaskCpfCnpjInput && window.uiFormatCpfCnpj) {
                        // Formatar valor inicial e aplicar máscara
                        try { input.value = window.uiFormatCpfCnpj(input.value); } catch (e) {}
                        window.uiMaskCpfCnpjInput(input);
                    }
                    var phone = dom.querySelector('input[name="telefone"]');
                    if (phone && window.uiMaskPhoneInput && window.uiFormatPhoneBR) {
                        try { phone.value = window.uiFormatPhoneBR(phone.value); } catch (e) {}
                        window.uiMaskPhoneInput(phone);
                    }
                },
                preConfirm: function () {
                    var container = Swal.getHtmlContainer();
                    var nome = container.querySelector('input[name="nome"]').value.trim();
                    var cpfCnpj = container.querySelector('input[name="cpfCnpj"]').value.trim();
                    var email = container.querySelector('input[name="email"]').value.trim();
                    var telefone = container.querySelector('input[name="telefone"]').value.trim();
                    if (!nome) {
                        Swal.showValidationMessage('Informe o nome do cliente.');
                        return false;
                    }
                    if (!cpfCnpj) {
                        Swal.showValidationMessage('Informe o CPF/CNPJ.');
                        return false;
                    }
                    if (!isValidCpfCnpj(cpfCnpj)) {
                        Swal.showValidationMessage('CPF/CNPJ inválido.');
                        return false;
                    }
                    if (email && !isValidEmail(email)) {
                        Swal.showValidationMessage('E-mail inválido.');
                        return false;
                    }
                    if (telefone && !isValidPhoneBR(telefone)) {
                        Swal.showValidationMessage('Telefone inválido. Use DDD + número.');
                        return false;
                    }
                    return uiSubmitFromSwal(url, 'POST', '#cliente-form').then(function (resp) {
                        if (!resp || !resp.ok) {
                            Swal.showValidationMessage((resp && resp.message) ? resp.message : 'Não foi possível salvar.');
                            return false;
                        }
                        return resp;
                    });
                }
            }).then(function (r) {
                if (r.isConfirmed) {
                    uiToastSuccess(r.value && r.value.message ? r.value.message : 'Salvo.');
                    refreshClientesList();
                }
            });
        }

        function confirmDeleteClienteFromRow(button) {
            var d = button ? button.dataset : {};
            var id = d.id;
            var nome = d.nome || 'cliente';
            uiConfirmDelete({
                title: 'Excluir cliente',
                text: 'Excluir ' + nome + '?'
            }).then(function (confirmed) {
                if (!confirmed) {
                    return;
                }
                uiFetchForm('/clientes/' + id + '/delete', 'POST', {}).then(function (resp) {
                    if (resp && resp.ok) {
                        uiToastSuccess(resp.message || 'Cliente excluído.');
                        refreshClientesList();
                    } else {
                        uiToastError(resp && resp.message ? resp.message : 'Não foi possível excluir.');
                    }
                });
            });
        }
    </script>
    <script>
        (function () {
            function applyFormatInList(scope) {
                if (window.uiApplyCpfCnpjFormattingIn) {
                    window.uiApplyCpfCnpjFormattingIn(scope || document);
                }
                if (window.uiApplyPhoneFormattingIn) {
                    window.uiApplyPhoneFormattingIn(scope || document);
                }
            }
            document.addEventListener('DOMContentLoaded', function () {
                applyFormatInList(document);
            });
            document.body.addEventListener('htmx:afterSwap', function (evt) {
                var tgt = evt && evt.detail && evt.detail.target;
                if (tgt && tgt.id === 'client-list') {
                    applyFormatInList(tgt);
                }
            });
        })();
    </script>
    <script>
        function digitsOnly(s) {
            return (s || '').replace(/\D+/g, '');
        }
        function isValidCpfCnpj(v) {
            var s = digitsOnly(v);
            if (s.length === 11) return isValidCpf(s);
            if (s.length === 14) return isValidCnpj(s);
            return false;
        }
        function isValidEmail(email) {
            if (!email) return true;
            var e = email.trim().toLowerCase();
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
        }
        function isValidPhoneBR(v) {
            var s = digitsOnly(v);
            return s.length === 10 || s.length === 11;
        }
        function isValidCpf(cpf) {
            if (/^(\d)\1+$/.test(cpf)) return false;
            var d1 = 0, d2 = 0, i, dig;
            for (i = 0; i < 9; i++) {
                dig = cpf.charCodeAt(i) - 48;
                d1 += dig * (10 - i);
                d2 += dig * (11 - i);
            }
            d1 = 11 - (d1 % 11);
            if (d1 >= 10) d1 = 0;
            d2 += d1 * 2;
            d2 = 11 - (d2 % 11);
            if (d2 >= 10) d2 = 0;
            return d1 === (cpf.charCodeAt(9) - 48) && d2 === (cpf.charCodeAt(10) - 48);
        }
        function isValidCnpj(cnpj) {
            if (/^(\d)\1+$/.test(cnpj)) return false;
            var w1 = [5,4,3,2,9,8,7,6,5,4,3,2];
            var w2 = [6,5,4,3,2,9,8,7,6,5,4,3,2];
            var s1 = 0, s2 = 0, i;
            for (i = 0; i < 12; i++) s1 += (cnpj.charCodeAt(i) - 48) * w1[i];
            var r1 = s1 % 11, d1 = r1 < 2 ? 0 : 11 - r1;
            for (i = 0; i < 13; i++) s2 += (i < 12 ? (cnpj.charCodeAt(i) - 48) : d1) * w2[i];
            var r2 = s2 % 11, d2 = r2 < 2 ? 0 : 11 - r2;
            return d1 === (cnpj.charCodeAt(12) - 48) && d2 === (cnpj.charCodeAt(13) - 48);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
