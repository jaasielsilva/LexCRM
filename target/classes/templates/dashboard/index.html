<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indicadores (MTD) - CRM Jurídico</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;600;700&display=swap"
        rel="stylesheet">

    <!-- CSRF Token -->
    <meta name="_csrf" th:content="${_csrf.token}" />
    <meta name="_csrf_header" th:content="${_csrf.headerName}" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <script src="https://unpkg.com/htmx.org@1.9.6"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <link rel="stylesheet" th:href="@{/css/style.css}">
    <link rel="stylesheet" th:href="@{/css/tailwind.css}">
</head>

<body class="bg-light">

    <div th:if="${#authentication?.name != null}" th:attr="data-user-email=${#authentication.name}"
        style="display: none;"></div>

    <div th:replace="~{fragments/sidebar :: sidebar(activePage='dashboard')}"></div>

    <main class="main-content" style="margin-left: 280px; padding: 32px; max-width: 1600px; margin: 0 auto 0 280px;">
        <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between">
                <div>
                    <h1 class="font-playfair text-lg font-bold text-navy-blue">Dashboard Executivo</h1>
                    <p class="text-xs text-slate-500">Clique nos cards para ver os detalhes abaixo.</p>
                </div>
                <div></div>
            </div>

            <div class="p-6 space-y-6">
                <div class="dashboard-kpi-grid">
                    <div class="dashboard-card dashboard-card--accent"
                        onclick="toggleDetails('faturamento_doze_meses', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${faturamentoDozeMeses}">R$ 0,00</div>
                            <div class="dashboard-card-label">Faturamento Ano Atual</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--success" onclick="toggleDetails('novos_contatos', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${novosContatosCount}">0</div>
                            <div class="dashboard-card-label">Novos Contatos (30 dias)</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--success"
                        onclick="toggleDetails('receber_seguradora', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${seguradoraAReceberTotal}">R$ 0,00</div>
                            <div class="dashboard-card-label">A Receber (Seg)</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-dollar-sign"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--success" onclick="toggleDetails('pagar_medico', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${medicosAPagarTotal}">R$ 0,00</div>
                            <div class="dashboard-card-label">A Pagar (Médicos)</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-user-md"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--danger"
                        onclick="toggleDetails('pendencias_criticas', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${pendenciasCriticasCount}">0</div>
                            <div class="dashboard-card-label">Pendências Críticas</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-triangle-exclamation"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--accent"
                        onclick="toggleDetails('processos_ativos', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${processosAtivosCount}">0</div>
                            <div class="dashboard-card-label">Processos Ativos</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-folder-open"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--success"
                        onclick="toggleDetails('processos_arquivados', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${processosArquivadosCount}">0</div>
                            <div class="dashboard-card-label">Arquivados (Deferidos)</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                    </div>
                </div>

                <div class="dashboard-flow-header">
                    <div class="dashboard-flow-title">Fluxo do Processo</div>
                    <div class="dashboard-flow-subtitle">Clique em uma etapa para filtrar e ver os itens abaixo.</div>
                </div>

                <div class="dashboard-flow-grid">
                    <div class="dashboard-card dashboard-card--info"
                        onclick="toggleDetails('etapa_contato', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_contato'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Contato</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-phone"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--warning"
                        onclick="toggleDetails('etapa_solicitacao', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_solicitacao'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Solicitação</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-clipboard-list"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--info"
                        onclick="toggleDetails('etapa_analise', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_analise'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Análise</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-magnifying-glass"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--warning"
                        onclick="toggleDetails('etapa_contrato', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_contrato'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Contrato</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-file-signature"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--accent"
                        onclick="toggleDetails('etapa_medico', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_medico'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Médico</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-stethoscope"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--info"
                        onclick="toggleDetails('etapa_seguradora', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_seguradora'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Seguradora</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-shield-halved"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--success"
                        onclick="toggleDetails('etapa_conclusao', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_conclusao'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Conclusão</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-flag-checkered"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--neutral"
                        onclick="toggleDetails('etapa_contador', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_contador'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Contador</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-calculator"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--neutral"
                        onclick="toggleDetails('etapa_dizimo', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_dizimo'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Dízimo</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-hand-holding-heart"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--info"
                        onclick="toggleDetails('etapa_indicacao', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_indicacao'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Indicação</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-users"></i>
                        </div>
                    </div>

                    <div class="dashboard-card dashboard-card--warning"
                        onclick="toggleDetails('etapa_nota_fiscal', this)">
                        <div class="dashboard-card-content">
                            <div class="dashboard-card-value" th:text="${flowCounts['etapa_nota_fiscal'] ?: 0}">0</div>
                            <div class="dashboard-card-label">Nota Fiscal</div>
                        </div>
                        <div class="dashboard-card-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                    </div>
                </div>

                <div id="card-detail-panel" class="mt-6 hidden">
                    <div class="dashboard-detail-panel">
                        <div class="dashboard-detail-header">
                            <div>
                                <h2 id="detail-title" class="dashboard-detail-title"></h2>
                            </div>
                            <div id="detail-value" class="dashboard-detail-value-amount"></div>
                        </div>
                        <div id="detail-action" class="mt-2 d-none">
                            <a id="detail-link" href="#" class="dashboard-detail-link">Ver todos</a>
                        </div>
                        <div id="detail-preview" class="dashboard-detail-preview d-none"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        var dashboardDetailsConfig = {
            faturamento_doze_meses: {
                statusType: 'good',
                statusLabel: 'faturamento',
                description: 'Faturamento bruto acumulado no ano atual (valores pagos).',
                trend: 'Visão anual do desempenho de receita.',
                nextStep: 'Analisar sazonalidade e projeções de crescimento.'
            },
            novos_contatos: {
                statusType: 'good',
                statusLabel: 'bom',
                description: 'Quantidade de novos clientes cadastrados nos últimos 30 dias.',
                trend: 'Mostra o ritmo recente de entrada de contatos na base.',
                nextStep: 'Classificar e qualificar esses contatos para oportunidades.',
                link: '/clientes',
                linkLabel: 'Ver clientes',
                preview: '/dashboard/preview?filtro=novos_contatos'
            },
            pagar_medico: {
                statusType: 'risk',
                statusLabel: 'risco',
                description: 'Montante de pagamentos pendentes a médicos, afetando diretamente a relação com parceiros.',
                trend: 'Acompanhar de perto os vencimentos mais próximos.',
                nextStep: 'Priorizar liquidação de valores críticos e alinhar com financeiro.',
                link: '/processos?filtro=pagar_medico',
                linkLabel: 'Ver processos com médicos a pagar',
                preview: '/dashboard/preview?filtro=pagar_medico'
            },
            pendencias_criticas: {
                statusType: 'risk',
                statusLabel: 'pendência',
                description: 'Processos parados em Solicitação ou Seguradora aguardando avanço.',
                trend: 'Quanto maior, maior o risco de atraso ou perda de caso.',
                nextStep: 'Priorizar follow-up com cliente e seguradora para destravar o fluxo.',
                link: '/processos?filtro=pendencias_criticas',
                linkLabel: 'Ver pendências críticas',
                preview: '/dashboard/preview?filtro=pendencias_criticas'
            },
            receber_seguradora: {
                statusType: 'good',
                statusLabel: 'bom',
                description: 'Valores previstos a receber de seguradoras relacionados a processos em curso.',
                trend: 'Boa perspectiva de entrada de caixa nos próximos períodos.',
                nextStep: 'Conferir processos próximos de liquidação e confirmar dados bancários.',
                link: '/processos?filtro=seguradora',
                linkLabel: 'Ver processos na seguradora',
                preview: '/dashboard/preview?filtro=seguradora'
            },
            processos_ativos: {
                statusType: 'neutral',
                statusLabel: 'carteira',
                description: 'Visão geral do volume de processos atualmente ativos na carteira.',
                trend: 'Ajuda a dimensionar carga de trabalho da equipe.',
                nextStep: 'Acompanhar distribuição entre times e evitar gargalos.',
                link: '/processos?filtro=ativos',
                linkLabel: 'Ver processos ativos',
                preview: '/dashboard/preview?filtro=ativos'
            },
            processos_arquivados: {
                statusType: 'good',
                statusLabel: 'bom',
                description: 'Processos arquivados com decisão favorável ou encerramento controlado.',
                trend: 'Mostra a eficiência da condução das demandas até o fechamento.',
                nextStep: 'Registrar aprendizados e atualizar indicadores internos de sucesso.',
                link: '/processos?filtro=arquivados',
                linkLabel: 'Ver arquivados',
                preview: '/dashboard/preview?filtro=arquivados'
            },

            etapa_contato: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Primeiro contato com o cliente e registro inicial da demanda.',
                trend: 'Indica entrada de novos casos no funil.',
                nextStep: 'Registrar interação e direcionar para solicitação.',
                link: '/processos?filtro=etapa_contato',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_contato'
            },
            etapa_solicitacao: {
                statusType: 'warning',
                statusLabel: 'etapa',
                description: 'Envio e acompanhamento da solicitação de documentos ou informações.',
                trend: 'Acompanhar tempo de resposta do cliente.',
                nextStep: 'Confirmar recebimento e seguir para análise.',
                link: '/processos?filtro=etapa_solicitacao',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_solicitacao'
            },
            etapa_analise: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Análise das informações e documentos recebidos.',
                trend: 'Impacta diretamente o tempo total do caso.',
                nextStep: 'Validar cenário e preparar minuta de contrato.',
                link: '/processos?filtro=etapa_analise',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_analise'
            },
            etapa_contrato: {
                statusType: 'warning',
                statusLabel: 'etapa',
                description: 'Formalização contratual e coleta de assinaturas.',
                trend: 'Ponto de fricção se o cliente demora a assinar.',
                nextStep: 'Garantir assinatura digital e registrar aceite.',
                link: '/processos?filtro=etapa_contrato',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_contrato'
            },
            etapa_medico: {
                statusType: 'warning',
                statusLabel: 'etapa',
                description: 'Agendamento e realização de perícia ou laudo médico.',
                trend: 'Controlar prazos e reagendamentos.',
                nextStep: 'Receber laudo e registrar resultado.',
                link: '/processos?filtro=etapa_medico',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_medico'
            },
            etapa_seguradora: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Envio e acompanhamento do processo junto à seguradora.',
                trend: 'Depende fortemente de SLA externo.',
                nextStep: 'Monitorar retorno e registrar decisões.',
                link: '/processos?filtro=etapa_seguradora',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_seguradora'
            },
            etapa_conclusao: {
                statusType: 'good',
                statusLabel: 'etapa',
                description: 'Conclusão do caso com deferimento ou encerramento controlado.',
                trend: 'Indicador direto de entrega e produtividade.',
                nextStep: 'Arquivar processo e consolidar aprendizados.',
                link: '/processos?filtro=etapa_conclusao',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_conclusao'
            },
            etapa_contador: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Envio e conciliação de informações com a contabilidade.',
                trend: 'Garante registros contábeis alinhados ao jurídico.',
                nextStep: 'Confirmar recebimento e atualizar histórico.',
                link: '/processos?filtro=etapa_contador',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_contador'
            },
            etapa_dizimo: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Cálculo e registro de contribuições de dízimo associadas ao caso.',
                trend: 'Relaciona ganhos jurídicos com compromissos ministeriais.',
                nextStep: 'Registrar contribuição e atualizar histórico financeiro.',
                link: '/processos?filtro=etapa_dizimo',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_dizimo'
            },
            etapa_indicacao: {
                statusType: 'neutral',
                statusLabel: 'etapa',
                description: 'Registro e validação de indicações vinculadas a novos clientes.',
                trend: 'Ajuda a medir geração de casos por relacionamento.',
                nextStep: 'Validar indicação e vincular ao processo.',
                link: '/processos?filtro=etapa_indicacao',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_indicacao'
            },
            etapa_nota_fiscal: {
                statusType: 'warning',
                statusLabel: 'etapa',
                description: 'Emissão e controle de notas fiscais ligadas ao processo.',
                trend: 'Afeta diretamente a visibilidade de faturamento.',
                nextStep: 'Emitir, anexar e confirmar situação fiscal.',
                link: '/processos?filtro=etapa_nota_fiscal',
                linkLabel: 'Ver processos nesta etapa',
                preview: '/dashboard/preview?filtro=etapa_nota_fiscal'
            }
        };

        var activeDashboardCardKey = null;

        function toggleDetails(key, cardElement) {
            var panel = document.getElementById('card-detail-panel');
            if (!panel || !cardElement) {
                return;
            }

            var isSameCard = activeDashboardCardKey === key && !panel.classList.contains('hidden');
            if (isSameCard) {
                activeDashboardCardKey = null;
                panel.classList.add('hidden');
                var previewToClear = document.getElementById('detail-preview');
                if (previewToClear) {
                    previewToClear.innerHTML = '';
                    previewToClear.classList.add('d-none');
                }
                var actionToHide = document.getElementById('detail-action');
                if (actionToHide) {
                    actionToHide.classList.add('d-none');
                }
                var cardsToReset = document.querySelectorAll('.dashboard-card');
                for (var c = 0; c < cardsToReset.length; c++) {
                    cardsToReset[c].classList.remove('dashboard-card-active');
                }
                return;
            }

            activeDashboardCardKey = key;

            var titleElement = cardElement.querySelector('.dashboard-card-label');
            var valueElement = cardElement.querySelector('.dashboard-card-value');
            var title = titleElement ? titleElement.textContent.trim() : '';
            var value = valueElement ? valueElement.textContent.trim() : '';
            var config = dashboardDetailsConfig[key] || {};

            var titleTarget = document.getElementById('detail-title');
            var valueTarget = document.getElementById('detail-value');

            if (titleTarget) {
                titleTarget.textContent = title;
            }
            if (valueTarget) {
                valueTarget.textContent = value;
            }

            var linkElement = document.getElementById('detail-link');
            var actionElement = document.getElementById('detail-action');
            if (linkElement && actionElement) {
                if (config.link && !config.preview) {
                    linkElement.href = config.link;
                    linkElement.textContent = config.linkLabel || 'Ver todos';
                    actionElement.classList.remove('d-none');
                } else {
                    linkElement.href = '#';
                    linkElement.textContent = 'Ver todos';
                    actionElement.classList.add('d-none');
                }
            }

            var previewElement = document.getElementById('detail-preview');
            if (previewElement) {
                if (config.preview) {
                    previewElement.classList.remove('d-none');
                    previewElement.innerHTML = '<div class=\"dashboard-preview-loading\">Carregando...</div>';
                    fetch(config.preview, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
                        .then(function (r) { return r.text(); })
                        .then(function (html) { previewElement.innerHTML = html; })
                        .catch(function () {
                            previewElement.innerHTML = '';
                            previewElement.classList.add('d-none');
                        });
                } else {
                    previewElement.innerHTML = '';
                    previewElement.classList.add('d-none');
                }
            }

            var cards = document.querySelectorAll('.dashboard-card');
            for (var i = 0; i < cards.length; i++) {
                cards[i].classList.remove('dashboard-card-active');
            }
            cardElement.classList.add('dashboard-card-active');

            panel.classList.remove('hidden');
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>
</body>

</html>
