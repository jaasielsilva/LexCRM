<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<body>

    <div th:fragment="sidebar(activePage)" class="sidebar" id="app-sidebar">
        <!-- Sidebar CSS Isolated -->
        <link rel="stylesheet" th:href="@{/css/sidebar.css}">

        <div class="sidebar-header">
            <div class="brand-icon">
                <i class="fas fa-briefcase"></i>
            </div>
            <div class="brand-text">
                <h1>Juris<span>CRM</span></h1>
                <p class="brand-subtitle">Gestão Jurídica</p>
            </div>
        </div>

        <div class="sidebar-menu">
            <div class="menu-category">Principal</div>
            <a href="/dashboard" class="nav-link" th:classappend="${activePage == 'dashboard'} ? 'active'">
                <i class="fas fa-th-large"></i>
                <span>Dashboard</span>
            </a>
            <a href="/clientes"
               class="nav-link"
               th:classappend="${activePage == 'clientes'} ? 'active'"
               sec:authorize="hasAuthority('CLIENTES_VIEW')">
                <i class="fas fa-users"></i>
                <span>Clientes</span>
            </a>
            <a href="/processos"
               class="nav-link"
               th:classappend="${activePage == 'processos'} ? 'active'"
               sec:authorize="hasAuthority('PROCESSOS_VIEW')">
                <i class="fas fa-balance-scale"></i>
                <span>Processos</span>
            </a>
            <a href="/documentacoes"
               class="nav-link"
               th:classappend="${activePage == 'documentacoes'} ? 'active'"
               sec:authorize="hasAuthority('PROCESSOS_VIEW')">
                <i class="fas fa-folder"></i>
                <span>Documentações</span>
            </a>

            <div sec:authorize="hasAnyAuthority('AGENDA_VIEW','FINANCEIRO_VIEW','RELATORIOS_VIEW')">
                <div class="menu-category">Gestão</div>
                <a href="/agenda"
                   class="nav-link"
                   th:classappend="${activePage == 'agenda'} ? 'active'"
                   sec:authorize="hasAuthority('AGENDA_VIEW')">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Agenda</span>
                </a>
                <a href="/financeiro"
                   class="nav-link"
                   th:classappend="${activePage == 'financeiro'} ? 'active'"
                   sec:authorize="hasAuthority('FINANCEIRO_VIEW')">
                    <i class="fas fa-dollar-sign"></i>
                    <span>Financeiro</span>
                </a>
                <a href="/relatorios"
                   class="nav-link"
                   th:classappend="${activePage == 'relatorios'} ? 'active'"
                   sec:authorize="hasAuthority('RELATORIOS_VIEW')">
                    <i class="fas fa-file-alt"></i>
                    <span>Relatórios</span>
                </a>
            </div>

            <div sec:authorize="hasAuthority('CONFIG_VIEW')">
                <div class="menu-category">Sistema</div>
                <a href="/configuracoes"
                   class="nav-link"
                   th:classappend="${activePage == 'configuracoes'} ? 'active'">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </div>
        </div>

        <div class="sidebar-footer" onclick="openPerfilModal()" style="cursor: pointer;" title="Meu Perfil">
            <div class="user-avatar">
                <span
                    th:text="${#authentication?.name != null && #authentication.name.length() >= 2 ? #authentication.name.substring(0,2).toUpperCase() : 'US'}">US</span>
            </div>
            <div class="user-info">
                <p class="user-name" th:text="${#authentication?.name ?: 'Visitante'}">Usuário</p>
            </div>
            <form th:action="@{/logout}" method="post" style="margin: 0;" onclick="event.stopPropagation()">
                <button type="submit" title="Sair"
                    style="background:none; border:none; color: #64748b; cursor: pointer; padding: 5px;">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </form>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script th:src="@{/js/ui-swal.js}"></script>
        <script>
            function openPerfilModal() {
                Swal.fire({
                    title: 'Carregando...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                        fetch('/perfil')
                            .then(response => response.text())
                            .then(html => {
                                Swal.fire({
                                    html: html,
                                    showConfirmButton: false,
                                    showCancelButton: false,
                                    width: 500,
                                    padding: '0',
                                    customClass: {
                                        popup: 'modal-content-premium'
                                    },
                                    didOpen: () => {
                                        const container = document.querySelector('.swal2-html-container');
                                        if (container && window.htmx) {
                                            htmx.process(container);
                                        }
                                    }
                                });
                            });
                    }
                });
            }

            function closeModal() {
                Swal.close();
            }

            window.togglePerfilTab = function (tab) {
                const formInfo = document.getElementById('form-perfil-info');
                const formSenha = document.getElementById('form-perfil-senha');
                const btnInfo = document.getElementById('btn-tab-info');
                const btnSenha = document.getElementById('btn-tab-senha');

                if (!formInfo || !formSenha) return;

                if (tab === 'info') {
                    formInfo.classList.remove('hidden');
                    formSenha.classList.add('hidden');
                    btnInfo.classList.add('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnInfo.classList.remove('text-gray-400', 'border-transparent');
                    btnSenha.classList.remove('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnSenha.classList.add('text-gray-400', 'border-transparent');
                } else {
                    formInfo.classList.add('hidden');
                    formSenha.classList.remove('hidden');
                    btnSenha.classList.add('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnSenha.classList.remove('text-gray-400', 'border-transparent');
                    btnInfo.classList.remove('active', 'border-[var(--navy-blue)]', 'text-[var(--navy-blue)]');
                    btnInfo.classList.add('text-gray-400', 'border-transparent');
                }
            }

            // Global HTMX CSRF Configuration
            document.body.addEventListener('htmx:configRequest', function (evt) {
                const tokenMeta = document.querySelector('meta[name="_csrf"]');
                const headerMeta = document.querySelector('meta[name="_csrf_header"]');
                if (tokenMeta && headerMeta) {
                    const token = tokenMeta.getAttribute('content');
                    const header = headerMeta.getAttribute('content');
                    evt.detail.headers[header] = token;
                }
            });

            // Global Pending Alert Check
            document.addEventListener('DOMContentLoaded', function () {
                fetch('/processos/pendencias/alerta-global')
                    .then(response => response.json())
                    .then(data => {
                        if (data.count && data.count > 0) {
                            // Using setTimeout to ensure UI is ready and not conflict with other toasts
                            setTimeout(() => {
                                if (window.uiToastError) {
                                    window.uiToastError('Atenção: Existem ' + data.count + ' processos com pendência de documentos há mais de 1 dia.');
                                }
                            }, 1000);
                        }
                    })
                    .catch(err => console.error('Error checking alerts:', err));
            });

            document.addEventListener('DOMContentLoaded', function () {
                function updateNotifBadge(count) {
                    var el = document.getElementById('sidebar-notif-count');
                    if (!el) return;
                    if (count && count > 0) {
                        el.textContent = String(count);
                        el.style.display = 'inline-flex';
                    } else {
                        el.style.display = 'none';
                    }
                }

                function toastForNotif(n) {
                    var msg = (n && (n.mensagem || n.titulo)) ? (n.mensagem || n.titulo) : 'Você tem uma notificação.';
                    if (n && (n.tipo === 'ERROR' || n.tipo === 'WARNING')) {
                        if (window.uiToastError) window.uiToastError(msg);
                    } else {
                        if (window.uiToastSuccess) window.uiToastSuccess(msg);
                    }
                }

                function pollNotificacoes(showToasts) {
                    fetch('/notificacoes/unread')
                        .then(r => r.json())
                        .then(data => {
                            updateNotifBadge(data && data.count ? data.count : 0);
                            if (!showToasts) return;
                            var items = (data && data.items) ? data.items : [];
                            var last = 0;
                            try { last = parseInt(localStorage.getItem('lexcrm_notif_last_id') || '0', 10) || 0; } catch (e) { last = 0; }
                            var newest = last;
                            for (var i = 0; i < items.length; i++) {
                                var id = parseInt(items[i].id, 10) || 0;
                                if (id > newest) newest = id;
                            }
                            if (newest > last) {
                                var shown = 0;
                                for (var j = items.length - 1; j >= 0; j--) {
                                    var nid = parseInt(items[j].id, 10) || 0;
                                    if (nid > last) {
                                        toastForNotif(items[j]);
                                        shown++;
                                        if (shown >= 3) break;
                                    }
                                }
                                try { localStorage.setItem('lexcrm_notif_last_id', String(newest)); } catch (e) { }
                            }
                        })
                        .catch(err => console.error('Error checking notifications:', err));
                }

                pollNotificacoes(true);
                setInterval(function () { pollNotificacoes(false); }, 60000);
            });
        </script>
    </div>

</body>

</html>
